<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<ui:composition template="/template/layout.xhtml" 
		xmlns:p="http://primefaces.org/ui"
		xmlns:ui="http://java.sun.com/jsf/facelets"
		xmlns:h="http://java.sun.com/jsf/html"
		xmlns:sh="http://java.sun.com/jsf/composite/components">
    <ui:define name="content">
    
    	<div class="well">
    		<h2>Proof of concept mode</h2>
    	</div>
    	
    	<div class="shimmerVisualisation panel panel-default">
			<div class="panel-heading">
				<h3 class="panel-title">Sample project visualiztion</h3>
			</div>
			<div class="panel-body">
				<h:outputText value="#{homePageController.helloWorld}" />
				
				<div id="shimmerContainer">
					<div id="shimmerHeatmap"></div>
					<div id="shimmerNetwork"></div>
					<div id="shimmerPanel" class="panel panel-primary">
						<div class="panel-heading">
							Visualisation panel
						</div>
						<div class="panel-body">
							<div>
								Visualisation Mode: <span id="visualisationMode" class="label label-primary">Constellation Mode</span>
							</div>
							<button class="btn btn-success btn-xs" onclick="toggleHeatmap();">Change Mode</button>
							
							<sh:calculatingIndicatior />
						</div>
					</div>
				</div>
				
				<div id="shimmerProject" class="panel panel-success">
					<div class="panel-heading">
						Project data
					</div>
					<div class="panel-body">
						Project information
					</div>
				</div>
				
			</div>
		</div>
		
		
		<script type="text/javascript">
		/* <![CDATA[ */
		
			// Ustawienia symulacji
			var Shimmer = {
				width: 800,
				height: 650,
				nodesCount: #{simulationController.nodesCount},
				enableHeatmap: true,
				heatmapUpdateInterval: 100,
				heatmapTimeout: 0,
			}
		
			// Nodes and edges
			var nodes = #{simulationController.nodesJSON}
			var edges = #{simulationController.edgesJSON}
		
			// create a network
			var container = document.getElementById('shimmerNetwork');
			var data = {
				nodes: nodes,
				edges: edges
			};
		  
			var options = {
				nodes: {
					shape: 'dot',
					fontColor: 'white',
					color: {background: 'lightgrey', border: 'transparent'},
				},
				edges: {
					width: 0,
				},
				smoothCurves: true,
				configurePhysics: true,
			};
			var network = new vis.Network(container, data, options);
		  
			var heatmap = h337.create({
				container: document.getElementById('shimmerHeatmap'),
				gradient: { .1: 'rgba(0,0,0,0)', 0.25: "rgba(0,0,90, .6)", .6: "blue", .9: "cyan", .95: 'rgba(255,255,255,.4)'},
				maxOpacity: .6,
				radius: 10,
				blur: .90
			});
			
			function getNodeX(i) {
				var canvasScaledXCenter = network.getScale() * network.getCenterCoordinates().x;
				var nodeScaledXDelta = Shimmer.width / 2 + network.getScale() * network.nodes[i].x;
				
				return Math.floor(nodeScaledXDelta - canvasScaledXCenter);
			}
			
			function getNodeY(i) {
				var canvasScaledYCenter = network.getScale() * network.getCenterCoordinates().y;
				var nodeScaledYDelta = Shimmer.height / 2 + network.getScale() * network.nodes[i].y;
				
				return Math.floor(nodeScaledYDelta - canvasScaledYCenter);
			}
			
			function getRandom(from, to) {
				return Math.floor((Math.random() * to) + from);
			}
			
			function getRandomColor() {
				if (getRandom(1, 100) < 15) {
					return 'red';
				} else if (getRandom(1, 100) > 85) {
					return 'green';
				} else {
					return 'lightgray';
				}
			}
		  
			function updateHeatmap(properties) {
				var nodesCount = Shimmer.nodesCount;
				var nodeX, nodeY;
		
				if (!Shimmer.enableHeatmap) {
					// Not updating heatmap when it's disabled
					return;
				}
				
				heatmap.setData({min: 0, max:30, data: []});
				for (i = 0; i < nodesCount; i++) {
					nodeX = getNodeX(i);
					nodeY = getNodeY(i);
					heatmap.addData({x: nodeX, y: nodeY, value: nodes[i].heatValue, radius: network.getScale() * 100});
				}
			};
			
			function startUpdatingHeatmap() {
				ShimmerWeb.show("calculatingStatus");
				Shimmer.heatmapTimeout = setInterval(function(){updateHeatmap()}, Shimmer.heatmapUpdateInterval);
			}
			
			function stopUpdatingHeatmap() {
				clearInterval(Shimmer.heatmapTimeout);
				ShimmerWeb.hide("calculatingStatus");
			}
			
			function toggleHeatmap() {
				Shimmer.enableHeatmap = !Shimmer.enableHeatmap;
				if (Shimmer.enableHeatmap) {
					$("#visualisationMode").text("Constallation");
					$("#visualisationMode").removeClass("label-warning");
					$("#visualisationMode").addClass("label-primary");
					network.setOptions({nodes:{color: {border: 'transparent', backgrund: 'lightgrey'}}})
					ShimmerWeb.show("shimmerHeatmap");
				} else {
					$("#visualisationMode").text("Graph");
					$("#visualisationMode").removeClass("label-primary");
					$("#visualisationMode").addClass("label-warning");
					network.setOptions({nodes:{color: {border: 'black', backgrund: 'black'}}})
					ShimmerWeb.hide("shimmerHeatmap");
				}
			}
			
			updateHeatmap();
		  
			network.on('viewChanged', updateHeatmap);
			network.on('startStabilization', startUpdatingHeatmap);
			network.on('stabilized', stopUpdatingHeatmap);
			
			/* ]]> */
		</script>
    </ui:define>
</ui:composition>
</html>