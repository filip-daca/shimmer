<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<ui:composition template="/template/layout.xhtml" 
		xmlns:p="http://primefaces.org/ui"
		xmlns:ui="http://java.sun.com/jsf/facelets"
		xmlns:h="http://java.sun.com/jsf/html"
		xmlns:f="http://java.sun.com/jsf/core"
		xmlns:sh="http://java.sun.com/jsf/composite/components">
    <ui:define name="content">

    	<div class="well">
    		<h2>Shimmering constellations</h2>
    		<h:form id="basicSettingsForm">
    			<!-- Project path -->
	    		<p:outputLabel value="Project *.class files path:" styleClass="wide-label" />
	    		<p:inputText value="#{simulationController.properties.directoryPath}" size="100" />
	    		
	    		<!-- Analysis start button -->
	    		<p:commandLink styleClass="btn btn-primary btn-sm margin-left" 
	    				ajax="true" global="true"
						actionListener="#{simulationController.generateGraph}"
						oncomplete="ShimmerWeb.componentShow('progressBar');
							PF('progressBar').start();
							PF('analysisCompletePoll').start();"
						onstart="ShimmerWeb.show('calculatingStatus');">
					<i class="glyphicon glyphicon-ok"></i>
				</p:commandLink>
	    		
	    		<!-- Load saved graph start button -->
	    		<p:fileUpload fileUploadListener="#{simulationController.loadGraph}" mode="advanced" dragDropSupport="false"
           			update="@([id$=dataScript])" sizeLimit="1000000" label="Upload analysed project graph" allowTypes="/(\.|\/)(json)$/"
           			onstart="ShimmerWeb.show('calculatingStatus');" global="true" auto="true" styleClass="margin-top" />
           			
           		<!-- Save graph -->
           		<p:commandButton value="Save analysed project" ajax="false" styleClass="save-graph-button"
           				onclick="PrimeFaces.monitorDownload(start, stop);" icon="ui-icon-arrowthick-1-s">
			        <p:fileDownload value="#{simulationController.saveGraph}" />
			    </p:commandButton>
				
				<!-- Analysis progress bar -->
				<p:progressBar id="progressBar" styleClass="margin-top" widgetVar="progressBar" ajax="true" 
					value="#{simulationController.loadingProgress}"
					labelTemplate="{value}%" global="false" interval="2500" style="display: none;" />
				
				<!-- Analysis complete poll -->
				<p:poll interval="5" stop="#{simulationController.visualizationReady}" autoStart="false"
					widgetVar="analysisCompletePoll" 
					update="@([id$=dataScript])" />
    		</h:form>
    	</div>
    	
    	<div class="shimmerVisualisation panel panel-default">
			<div class="panel-heading">
				<h3 class="panel-title">Project visualiztion</h3>
			</div>
			<div class="panel-body">
			
			<p:outputPanel id="shimmerSimulation">
				
				<div id="shimmerContainer">
					<div id="shimmerHeatmap"></div>
					<div id="shimmerNetwork"></div>
					
					<sh:projectInformation />
				</div>
			
				<div id="shimmerPanel" class="panel panel-primary">
					<div class="panel-heading">
						Simulation <sh:calculatingIndicatior />
					</div>
					<div class="panel-body">
						<div>
							<button class="btn btn-success btn-sm width-half margin-bottom" 
								onclick="Shimmer.toggleHeatmap();">Change Mode</button>
						</div>
						
						<p:outputLabel value="Visualisation Mode: "/><span id="visualisationMode" class="label label-primary">Constellation Mode</span>

						<div>
							<h:form id="extraSettingsForm">
								<p:inputText value="#{simulationController.properties.constellation}" 
									id="constellationModeSwitch" type="hidden" />
							
								<div>
									<p:outputLabel value="Package tree edges: "/>
									<p:inputSwitch value="#{simulationController.properties.packageTreeEdges}">
										<ui:include src="/resources/snippets/visualisationChangeAjax.xhtml" />
									</p:inputSwitch>
								</div>
								
								<div>
									<p:outputLabel value="Dependencies edges: "/>
									<p:inputSwitch value="#{simulationController.properties.dependenciesEdges}">
										<ui:include src="/resources/snippets/visualisationChangeAjax.xhtml" />
									</p:inputSwitch>
								</div>
								
								<div>
									<p:outputLabel value="Weighted dependencies: "/>
									<p:inputSwitch value="#{simulationController.properties.dependenciesWeighted}">
										<ui:include src="/resources/snippets/visualisationChangeAjax.xhtml" />
									</p:inputSwitch>
								</div>
								
								<div>
									<p:outputLabel value="Full package tree: "/>
									<p:inputSwitch value="#{simulationController.properties.fullPackageTree}">
										<ui:include src="/resources/snippets/visualisationChangeAjax.xhtml" />
									</p:inputSwitch>
								</div>
								
								<div>
									<p:outputLabel value="Library packages: "/>
									<p:inputSwitch value="#{simulationController.properties.libraryPackages}">
										<ui:include src="/resources/snippets/visualisationChangeAjax.xhtml" />
									</p:inputSwitch>
								</div>
							
								<p:outputLabel for="sizeMetricField" value="Node size metric:" />
								<h:selectOneMenu id="sizeMetricField"
										value="#{simulationController.properties.nodeSizeMetric}">
									<f:selectItems value="#{enumSelectItemsProvider.sizeMetrics}" />
									<ui:include src="/resources/snippets/visualisationChangeAjax.xhtml" />
								</h:selectOneMenu>
								
								<p:outputLabel for="colorMetricField" value="Node color metric:" />
								<h:selectOneMenu id="colorMetricField"
										value="#{simulationController.properties.nodeColorMetric}">
									<f:selectItems value="#{enumSelectItemsProvider.colorMetrics}" />
									<ui:include src="/resources/snippets/visualisationChangeAjax.xhtml" />
								</h:selectOneMenu>
								
								<p:outputLabel for="heatMetricField" value="Node heat metric:" />
								<h:selectOneMenu id="heatMetricField"
										value="#{simulationController.properties.nodeHeatMetric}">
									<f:selectItems value="#{enumSelectItemsProvider.heatMetrics}" />
									<ui:include src="/resources/snippets/visualisationChangeAjax.xhtml" />
								</h:selectOneMenu>
							</h:form>
						</div>
					</div>
				</div>
			
				<sh:bugReport />
			</p:outputPanel>	
			</div>
		</div>
		
		<!-- This is standard script field -->
		<script type="text/javascript">
		/* <![CDATA[ */
		             
		    Shimmer.data = {
				nodes: [],
				edges: []
			};
		
			// Simulation settings
			Shimmer.width = 800;
			Shimmer.height = 650;

			// Create a network and heatmap
			Shimmer.networkContainer = document.getElementById('shimmerNetwork');
			Shimmer.heatmapContainer = document.getElementById('shimmerHeatmap');
			Shimmer.constellationSwitch = $('input[id$=constellationModeSwitch]');
			Shimmer.createNetwork();
			Shimmer.createHeatmap();
			
			Shimmer.updateHeatmap();
		  
			// Assign listeners
			Shimmer.network.on('viewChanged', Shimmer.updateHeatmap);
			Shimmer.network.on('startStabilization', Shimmer.startUpdatingHeatmap);
			Shimmer.network.on('stabilized', Shimmer.stopUpdatingHeatmap);
			Shimmer.network.on('select', Shimmer.nodeSelectCallback);
			
			/* ]]> */
		</script>
		
		<!-- This field is updated every time the data changes -->
		<p:outputPanel id="dataScript">
			<ui:fragment rendered="#{simulationController.visualizationReady}">
				<script type="text/javascript">
				/* <![CDATA[ */
				
					// Nodes and edges
					var nodes = #{simulationController.nodesJSON}
					var edges = #{simulationController.edgesJSON}
				    
					Shimmer.data = {
						nodes: nodes,
						edges: edges
					};
					
					// Reloading data after update
					ShimmerWeb.hide('calculatingStatus');
					Shimmer.reloadData();
					ShimmerWeb.componentHide('progressBar');
					
				/* ]]> */
				</script>
			</ui:fragment>
		</p:outputPanel>
    </ui:define>
</ui:composition>
</html>